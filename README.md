# TryOn_ComfyUI
"Примерка одежды на людях с разным телосложением в ComfyUI"


## Обзор основных workflow

1. **Try On IPAdapterXL**

   * С помощью CLIPSeg создаю маску для inpaint на модели, а также отделяю платье, которое надеваем на модель.
   * В InpaintModelConditioning передаю изображение модели и маску старой одежды/тела, куда через IP-адаптер вписывается новое платье.
   * Модель работает на базе SDXL. Далее через контрольный узел F1 немного подтягиваю общее качество и убираю основные дефекты.

2. **IDM-VTON**

   * Продолжение первого флоу; пришлось разделить на два, поскольку IDM-VTON требует 16 GB GPU, а у меня RTX 5070 Ti.
   * CLIPSeg повторяется из первого флоу, затем подтягиваю размер оригинала и переодеваю модель с помощью IDM-VTON.
     \\

## Вспомогательные workflow

   **Depth Pose Flux**

   * Дополнительный флоу для генерации модели в позе из референса.
   * Использую ControlNet (режим Depth) и узел Depth Anything v2.

   **Img2Img + Fix**

   * Флоу для "раздевания" модели.
   * CLIPSeg для маски, InpaintModelConditioning (важная нода, благодаря которой inpaint идёт гладко без сильных швов), далее через Flux подтягиваю качество.

## Основные сложности и настройки

1. **Первый опыт на ComfyUI**

   * Было тяжело разобраться с кастомными нодами. К сожалению, не нашёл рабочего варианта, чтобы реализовать схему Flux с Inpaint + IP-адаптер не на SDXL, а на Flux.

2. **Подбор параметров threshold и blur\_sigma в CLIPSeg**

   * От качества маски сильно зависит итоговое изображение. Для разных тел приходилось подбирать разные значения и промпты.

3. **Проблемы с импортами**

   * Многие ноды не работали из коробки. Пришлось править код и разбираться с импортами.
   * Исправленный `PipelineLoader` для VTON лежит в папке `nodes`.

4. **Подбор параметра denoise**

   * Для каждой модели и сценария методом перебора находил оптимальные значения.

5. **Текстовые промпты в узлах**

   * Во многих нодах требуются индивидуальные промпты для наилучшего результата. Здесь я не сильно старался, и, вероятно, можно было сделать намного лучше.

6. **Параметры сэмплера**

   * Подбор параметров также происходил методом перебора.
   * Обычно использую схемы euler или DPM2 (Scheduler) — normal или Karras.

## Список используемых моделей

1. JuggernautXL Inpaint
2. RealDream F1 V1
3. IDM-VTON

**Вспомогательные модели:**

* CLIP ViT-G
* CLIPSeg

## Использование LoRA

LoRA не использовал. Если честно, не вижу, как здесь можно применить LoRA чтобы сильно увеличить качество результата. На ум приходит:

* Тренировка LoRA на уже готовом платье.
* Использование готовых LoRA для поз, детализации или для адаптации модели к сложным формам одежды.
